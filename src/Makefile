# Builds main game

APPNAME = raiders
ROOTDIR = ../

# Setup libraries pathes and flags

LIBDIR 		= $(ROOTDIR)lib
LIBBASS 	= $(LIBDIR)/audio/3rdparty
LIBAUDIO 	= $(LIBDIR)/audio
LIBWINDOW = $(LIBDIR)/window
LIBMATH 	= $(LIBDIR)/math
LIBDRAW 	= $(LIBDIR)/draw
LIBSYSTEM = $(LIBDIR)/system
LDFLAGS 	= -lwindow -lmath -ldraw -lsystem -laudio	# internal
LDFLAGS  += -lbass -lX11 -lGL -lGLU -lXrandr				# external

# Setup compiler

CXX 			= g++
CXXFLAGS 	= -I $(ROOTDIR) -ansi -pedantic -Wall -Wextra -std=c++14
CXXLIBS  += -L $(LIBBASS) -L $(LIBAUDIO) -L $(LIBWINDOW)
CXXLIBS  += -L $(LIBMATH) -L $(LIBDRAW) -L $(LIBSYSTEM)
CXXFLAGS += -MP -MMD
DBGFLAGS  = -ggdb3 -DDEBUG -O0
DBGFLAGS += -pg -no-pie		# profiler flags
RLSFLAGS  = -O2

# Setup objects

VPATH = $(ROOTDIR)src/entities/
OBJECTS = logic.o level.o scene.o starship.o

# Export libbass.so library path

LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(LIBBASS)
export LD_LIBRARY_PATH

# Other stuff

SRCFILES 	= $(wildcard *.cc)
.PHONY: clean

##############################################################################

# Builds game objects (debug or release)

ifeq ($(MAKECMDGOALS), debug)
%.o : %.cc %.h
	$(CXX) $(CXXFLAGS) $(DBGFLAGS) -c $< -o $@
else
%.o : %.cc %.h
	$(CXX) $(CXXFLAGS) $(RLSFLAGS) -c $< -o $@
endif

# Builds main app (release)

$(APPNAME) : $(APPNAME).cc $(OBJECTS)
	make -C $(LIBWINDOW)
	make -C $(LIBMATH)
	make -C $(LIBAUDIO)
	make -C $(LIBDRAW)
	make -C $(LIBSYSTEM)
	$(CXX) $(CXXFLAGS) $(CXXLIBS) $(RLSFLAGS) $< $(OBJECTS) $(LDFLAGS) -o $@

# Builds main app (debug)

debug : $(APPNAME).cc $(OBJECTS)
	make debug -C $(LIBWINDOW)
	make debug -C $(LIBMATH)
	make debug -C $(LIBAUDIO)
	make debug -C $(LIBDRAW)
	make debug -C $(LIBSYSTEM)
	$(CXX) $(CXXFLAGS) $(CXXLIBS) $(DBGFLAGS) $< $(OBJECTS) $(LDFLAGS) -o $(APPNAME)_$@

#############################################################################

# Includes dependicies files early generated by gcc with -MP -MMD opts

-include $(SRCFILES:%.cc=%.d)

# Cleans garbage

clean :
	rm -rf gmon.out
	rm -rf $(APPNAME) $(APPNAME)_* *.d *.o 
	make clean -C $(LIBWINDOW)
	make clean -C $(LIBMATH)
	make clean -C $(LIBAUDIO)
	make clean -C $(LIBDRAW)
	make clean -C $(LIBSYSTEM)