# Builds static library libdraw.a
# Dependicies: libwindow.a, libmath.a, lib/data/ply_loader.o)

LIBNAME = libdraw.a
SRCDIR = ./
DATADIR = ../data/
EXTRASDIR = ./extras/
ROOTDIR = ../../

# Setup dependicies libs

LIBWINDOW = $(ROOTDIR)lib/window
LIBMATH = $(ROOTDIR)lib/math
LDFLAGS = -lwindow -lmath

# Compiler settings

CXX = g++
CXXFLAGS = -I $(SRCDIR) -I $(EXTRASDIR) -ansi -pedantic -Wall -Wextra -std=c++14 
CXXFLAGS += -L $(LIBWINDOW) -L $(LIBMATH)
CXXFLAGS += -MP -MMD
DBGFLAGS = -ggdb3 -DDEBUG -O0 -pg -no-pie
RLSFLAGS = -O2

# Setup objects

VPATH =  $(DATADIR):$(EXTRASDIR)
OBJECTS = ply_loader.o terrain.o skybox.o
DBGOBJECTS = ply_loaderdbg.o terraindbg.o skyboxdbg.o

# Other stuff

SRCFILES = $(wildcard *.cc)
.PHONY: clean

##############################################################################

# Build library (release version)

$(LIBNAME) : $(SRCFILES:%.cc=%.o) $(OBJECTS)
	make -C $(LIBWINDOW)
	make -C $(LIBMATH)
	ar crs $(LIBNAME) $(SRCFILES:%.cc=%.o) $(OBJECTS)
	ranlib $(LIBNAME)

%.o : %.cc %.h
	$(CXX) $(CXXFLAGS) $(RLSFLAGS) -c $< -o $@

# Build library (debug version)

debug	: $(SRCFILES:%.cc=%dbg.o) $(DBGOBJECTS)
	make debug -C $(LIBWINDOW)
	make debug -C $(LIBMATH)	
	ar crs $(LIBNAME) $(SRCFILES:%.cc=%dbg.o) $(DBGOBJECTS)
	ranlib $(LIBNAME)

%dbg.o : %.cc %.h
	$(CXX) $(CXXFLAGS) $(DBGFLAGS) -c $< -o $@

##############################################################################

# Include dependicies files early generated by compiler with -MP -MMD opts

-include $(SRCFILES:%.cc=%.d)

# Clean garbage

clean :
	rm -f *.o *.d $(LIBNAME)
	make clean -C $(LIBWINDOW)
	make clean -C $(LIBMATH)
